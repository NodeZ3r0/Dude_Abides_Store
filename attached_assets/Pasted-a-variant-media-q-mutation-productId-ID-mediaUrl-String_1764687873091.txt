a>     variant_media_q = """                  >     mutation ($productId: ID!, $mediaUrl: String!) {                                      >         productMediaCreate(input: {product: $productId, mediaUrl: $mediaUrl, alt: ""}) {  >             media { id }                    d)>             errors { field message }      >         }                                   >     }                                       t>     """                                    >                                             >     assign_media_q = """                    >     mutation ($mediaId: ID!, $variantId: ID!) {                                           >         variantMediaAssign(mediaId: $mediaId, variantId: $variantId) {                    >             errors { field message }        >         }                                   tr>     }                                     >     """                                     et>                                           n {>     images_uploaded = 0                  ), >     for sku, mockup_url in sku_to_mockup.items():                                      >         variant_id = sku_to_variant_id.get(sku)                                           >         if not variant_id:                  >             logger.warning(f"No variant ID found for SKU {sku}")                          >             continue                        >                                             >         try:                                >             # Create media on product       >             media_res = saleor_graphql(     >                 variant_media_q,            >                 {"productId": product_id, "mediaUrl": mockup_url},                        >             )                               >                                             >             media_id = media_res.get("productMediaCreate", {}).get("media", {}).get("id") >             if media_id:                    >                 # Assign media to variant   >                 saleor_graphql(             >                     assign_media_q,         >                     {"mediaId": media_id, "variantId": variant_id},                       >                 )                           >                 images_uploaded += 1        >                 logger.info(f"Assigned mockup image to variant {sku}")                    >             else:                           >                 logger.warning(f"Failed to get media ID for {sku}")                       >         except Exception as e:              >             logger.error(f"Failed to upload image for {sku}: {e}")                        >                                             >     logger.info(f"Uploaded {images_uploaded} variant images")                             >                                             >     # Final publish                         >     saleor_graphql(                         >         publish_query,                      >         {                                   >             "id": product_id,               >             "input": {                      >                 "updateChannels": [{        >                     "channelId": "Q2hhbm5lbDoy",                                          >                     "isPublished": True,    >                     "visibleInListings": True,                                            >                     "isAvailableForPurchase": True,                                       >                 }]                          >             },                              >         },                                  >     )                                       >                                             >     return {"success": True, "product_id": product_id, "variants": len(variants), "images": images_uploaded}                            >                                             > # -------------------------------------     > # ENDPOINTS                                 > # -------------------------------------     > @app.get("/health")                         > def health():                               >     return {"ok": True}                     >                                             > @app.post("/import/printful/{template_id}") > async def import_endpoint(template_id: int):>     return import_printful_product(template_id)                                           >                                             > @app.post("/webhooks/printful")             > async def printful_webhook_legacy(request: Request, x_printful_event: str = Header(None)):>     body = await request.json()             >     pid = body.get("data", {}).get("sync_product", {}).get("id")                          >     if x_printful_event in ["product_synced", "product_updated"] and pid:                 >         return import_printful_product(pid) >     return {"ok": True}                     >                                             > @app.post("/webhook/printful")              > async def printful_webhook(request: Request):
>     try:                                    >         payload = await request.json()      >         event_type = payload.get("type")    >         data = payload.get("data", {})      >                                             >         logger.info(f"Printful webhook received: {event_type}")                           >                                             >         if event_type in ("product_synced", "product_updated"):                           >             sync_product = data.get("sync_product", {})                                   >             template_id = sync_product.get("id")                                          >                                             >             if template_id:                 >                 logger.info(f"Auto-importing Printful product {template_id}")             >                 result = import_printful_product(template_id)                             >                 return {"success": True, "event": event_type, "result": result}           >             else:                           >                 return {"success": False, "error": "No template ID in payload"}           >                                             >         return {"success": True, "event": event_type, "action": "ignored"}                >                                             >     except Exception as e:                  >         logger.error(f"Webhook error: {e}")
>         return {"success": False, "error": str(e)}
>                                             > @app.post("/sync")                          > async def sync_all():                       >     """Pull all products from Printful and import them."""                                >     logger.info("Starting full Printful sync")                                            >                                             >     url = f"https://api.printful.com/store/products?store_id={PRINTFUL_STORE_ID}"         >     r = requests.get(url, headers={"Authorization": f"Bearer {PRINTFUL_API_KEY}"}, timeout=30)                                          >     r.raise_for_status()                    >     products = r.json().get("result", [])   >                                             >     results = []                            >     for p in products:                      >         template_id = p.get("id")           >         try:                                >             result = import_printful_product(template_id)                                 >             results.append({"id": template_id, "status": "ok", "result": result})         >         except Exception as e:              >             logger.error(f"Failed to import {template_id}: {e}")                          >             results.append({"id": template_id, "status": "error", "error": str(e)})       >                                             >     return {"synced": len(results), "results": results}                                   > ENDOFFILE                                   root@WOPR:/opt/printful-sync# cd /opt/printful-sync && docker-compose down && docker-compose up -d --build && sleep 5 && curl -X POST http://localhost:8055/sync                        Stopping printful-sync-printful-sync-1 ... donRemoving printful-sync-printful-sync-1 ... donNetwork authentik_default is external, skipping                                             Building printful-sync                        [+] Building 0.1s (10/10) FINISHED docker:defa => [internal] load build definition fr  0.0s  => => transferring dockerfile: 284B     0.0s  => [internal] load metadata for docker  0.0s  => [internal] load .dockerignore        0.0s
 => => transferring context: 2B          0.0s  => [1/5] FROM docker.io/library/python  0.0s  => [internal] load build context        0.0s  => => transferring context: 15.79kB     0.0s  => CACHED [2/5] WORKDIR /app            0.0s  => CACHED [3/5] COPY requirements.txt   0.0s  => CACHED [4/5] RUN pip install --no-c  0.0s  => [5/5] COPY . .                       0.0s  => exporting to image                   0.0s  => => exporting layers                  0.0s  => => writing image sha256:eec4a9ac32d  0.0s  => => naming to docker.io/library/prin  0.0s Creating printful-sync-printful-sync-1 ... don{"synced":1,"results":[{"id":403918567,"status":"ok","result":{"success":true,"product_id":"UHJvZHVjdDo2","variants":17,"images":0}}]}root@WOPR:/opt/printful-sync#                     root@WOPR:/opt/printful-sync#