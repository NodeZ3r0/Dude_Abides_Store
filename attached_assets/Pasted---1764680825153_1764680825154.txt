        },                                        )                                                                                           # Create attributes                           size_attr = ensure_attribute("size", "Size")                                                color_attr = ensure_attribute("color", "Color")                                                                                           # Variants                                    variant_inputs = []                           for v in variants:                                size_val = ensure_attribute_value(size_attr, v.get("size", "One Size"))                     color_val = ensure_attribute_value(color_attr, v.get("color", "Default"))                                                                 variant_inputs.append(                            {                                                 "sku": v["sku"],                              "name": v["name"],                            "attributes": [                                   {"id": size_attr, "values": [size_val]},                                                    {"id": color_attr, "values": [color_val]},                                              ],                                            "channelListings": [                              {                                                 "channelId": "Q2hhbm5lbDoy",                                                                "price": str(v["retail_price"]),                                                        }                                         ],                                            "stocks": [                                       {                                                 "warehouse": "V2FyZWhvdXNlOjA4NjdhNzM5LThjYjQtNDlkNy1hNDdjLWJkODJkYTRiMDI2ZQ==",                                                          "quantity": 999,                          }                                         ],                                        }                                         )                                                                                       variant_query = """                           mutation ($product: ID!, $variants: [ProductVariantBulkCreateInput!]!) {                      productVariantBulkCreate(product: $product, variants: $variants) {                            count                                         results { productVariant { id sku } errors { field message } }                            }                                           }                                             """                                                                                         saleor_graphql(variant_query, {"product": product_id, "variants": variant_inputs})                                                        # Publish                                     saleor_graphql(                                   publish_query,                                {                                                 "id": product_id,                             "input": {                                        "updateChannels": [{                              "channelId": "Q2hhbm5lbDoy",                                                                "isPublished": True,                          "visibleInListings": True,                    "isAvailableForPurchase": True,                                                         }]                                        },                                        },                                        )                                                                                           # Image                                       if product.get("thumbnail_url"):                  media_q = """                                 mutation ($productId: ID!, $mediaUrl: String!) {                                              productMediaCreate(input: {product: $productId, mediaUrl: $mediaUrl, alt: ""}) {              errors { field message }                    }                                           }                                             """                                           saleor_graphql(                                   media_q,                                      {"productId": product_id, "mediaUrl": product["thumbnail_url"]},                        )                                                                                       return {"success": True, "product_id": product_id, "variants": len(variants)}                                                         # -------------------------------------       # ENDPOINTS                                   # -------------------------------------       @app.get("/health")                           def health():                                     return {"ok": True}                                                                     @app.post("/import/printful/{template_id}")   async def import_endpoint(template_id: int):      return import_printful_product(template_id)                                                                                           @app.post("/webhooks/printful")               async def printful_webhook_legacy(request: Request, x_printful_event: str = Header(None)):      body = await request.json()                   pid = body.get("data", {}).get("sync_product", {}).get("id")                                if x_printful_event in ["product_synced", "product_updated"] and pid:                           return import_printful_product(pid)       return {"ok": True}                                                                     @app.post("/webhook/printful")                async def printful_webhook(request: Request):     try:                                              payload = await request.json()                event_type = payload.get("type")              data = payload.get("data", {})                                                              logger.info(f"Printful webhook received: {event_type}")                                                                                   if event_type in ("product_synced", "product_updated"):                                         sync_product = data.get("sync_product", {})                                                 template_id = sync_product.get("id")                                                                                                      if template_id:                                   logger.info(f"Auto-importing Printful product {template_id}")                               result = import_printful_product(template_id)                                               return {"success": True, "event": event_type, "result": result}                         else:                                             return {"success": False, "error": "No template ID in payload"}                                                                   return {"success": True, "event": event_type, "action": "ignored"}                                                                    except Exception as e:                            logger.error(f"Webhook error: {e}")           return {"success": False, "error": str(e)}                                                                                        @app.post("/sync")                            async def sync_all():                             """Pull all products from Printful and import them."""                                      logger.info("Starting full Printful sync")                                                  url = f"https://api.printful.com/store/products?store_id={PRINTFUL_STORE_ID}"               r = requests.get(url, headers={"Authorization": f"Bearer {PRINTFUL_API_KEY}"}, timeout=30)                                                r.raise_for_status()                          products = r.json().get("result", [])                                                       results = []                                  for p in products:                                template_id = p.get("id")                     try:                                              result = import_printful_product(template_id)                                               results.append({"id": template_id, "status": "ok", "result": result})                   except Exception as e:                            logger.error(f"Failed to import {template_id}: {e}")                                        results.append({"id": template_id, "status": "error", "error": str(e)})                                                           return {"synced": len(results), "results": results}                                     root@WOPR:/opt/printful-sync# # 1. Get the correct channel ID                               root@WOPR:/opt/printful-sync# docker exec -it saleor-api-dude python manage.py shell -c "   > from saleor.channel.models import Channel   > import base64                               > c = Channel.objects.get(slug='the-dude-abides-shop')                                      > gid = base64.b64encode(f'Channel:{c.id}'.encode()).decode()                               > print(f'Channel ID: {c.id}')                > print(f'GraphQL ID: {gid}')                 > "                                                                                         # 2. Create warehouse                         docker exec -it saleor-api-dude python manage.py shell -c "                                 from saleor.warehouse.models import Warehouse from django_countries import countries        import base64                                                                               w, created = Warehouse.objects.get_or_create(     slug='default-warehouse',                     defaults={                                        'name': 'Default Warehouse',                  'address': None,                          }
)                                             gid = base64.b64encode(f'Warehouse:{w.id}'.encode()).decode()                               print(f'Warehouse: {w.slug} (created={created})')                                           print(f'GraphQL ID: {gid}')                   "                                                                                           # 3. Check product type                       docker exec -it saleor-api-dude python manage.py shell -c "                                 from saleor.product.models import ProductType import base64                                 for pt in ProductType.objects.all():              gid = base64.b64encode(f'ProductType:{pt.id}'.encode()).decode()                            print(f'{pt.id}: {pt.name} has_variants={pt.has_variants} gid={gid}')                   "                                             2025-12-02 13:06:31,735 WARNING saleor.core.jwt_manager RSA_PRIVATE_KEY is missing. Using temporary key for local development with DEBUG mode. [PID:304:MainThread]                     Channel ID: 2                                 GraphQL ID: Q2hhbm5lbDoy                      root@WOPR:/opt/printful-sync#