^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/psycopg/connection.py", line 119, in connect
    raise last_ex.with_traceback(None)
django.db.utils.OperationalError: connection failed: connection to server at "172.20.0.6", port 5432 failed: Connection refused
        Is the server running on that host and accepting TCP/IP connections?
root@WOPR:~# docker exec saleor-api-dude env | grep DATABASE
DATABASE_URL=postgres://saleor:saleor@saleor-postgres-dude:5432/saleor
root@WOPR:~#
root@WOPR:~# docker inspect saleor-postgres-dude | grep IPAddress
                    "IPAddress": "172.20.0.7",
root@WOPR:~# docker restart saleor-api-dude
saleor-api-dude
root@WOPR:~# sleep 5
root@WOPR:~# docker logs saleor-api-dude --tail 5
[2025-12-02 10:58:21 +0000] [22] [INFO] Started server process [22]
[2025-12-02 10:58:21 +0000] [23] [INFO] Booting worker with pid: 23
[2025-12-02 10:58:21 +0000] [24] [INFO] Booting worker with pid: 24
[2025-12-02 10:58:21 +0000] [23] [INFO] Started server process [23]
[2025-12-02 10:58:21 +0000] [24] [INFO] Started server process [24]
root@WOPR:~# docker stop saleor-api-dude
saleor-api-dude
root@WOPR:~# docker start saleor-api-dude
saleor-api-dude
root@WOPR:~# sleep 5
root@WOPR:~# docker logs saleor-api-dude --tail 5
[2025-12-02 11:00:25 +0000] [24] [INFO] Started server process [24]
[2025-12-02 11:00:25 +0000] [25] [INFO] Booting worker with pid: 25
[2025-12-02 11:00:25 +0000] [25] [INFO] Started server process [25]
[2025-12-02 11:00:25 +0000] [26] [INFO] Booting worker with pid: 26
[2025-12-02 11:00:25 +0000] [26] [INFO] Started server process [26]
root@WOPR:~# docker exec saleor-api-dude ping -c 2 saleor-postgres-dude
OCI runtime exec failed: exec failed: unable to start container process: exec: "ping": executable file not found in $PATH
root@WOPR:~# # Or check what IP it resolves toroot@WOPR:~# docker exec saleor-api-dude getent hosts saleor-postgres-dude
172.20.0.6      saleor-postgres-dude
root@WOPR:~# sudo systemctl restart docker
# Wait for containers to come back up
sleep 10
# Start the containers again
docker start saleor-postgres-dude saleor-redis-dude saleor-api-dude saleor-worker-dude
# Verify DNS is now correct
docker exec saleor-api-dude getent hosts saleor-postgres-dude
root@WOPR:~# docker exec saleor-api-dude getent hosts saleor-postgres-dude
Error response from daemon: container 2a9d95a1ef1d35a1673b0a58a26556a8908cef6cf40ed30e43edaa6e88a5c3b2 is not running
root@WOPR:~# docker start saleor-postgres-dudesaleor-postgres-dude
root@WOPR:~# sleep 5

root@WOPR:~# docker start saleor-redis-dude
saleor-redis-dude
root@WOPR:~# docker start saleor-api-dude
saleor-api-dude
root@WOPR:~# docker start saleor-worker-dude
saleor-worker-dude
root@WOPR:~# sleep 5

root@WOPR:~# docker exec saleor-api-dude getent hosts saleor-postgres-dude
172.20.0.6      saleor-postgres-dude
root@WOPR:~#
root@WOPR:~# docker inspect saleor-postgres-dude | grep IPAddress
                    "IPAddress": "172.20.0.3",
root@WOPR:~# docker network disconnect authentik_default saleor-postgres-dude
root@WOPR:~# docker network connect authentik_default saleor-postgres-dude
root@WOPR:~# docker inspect saleor-postgres-dude | grep IPAddress
                    "IPAddress": "172.20.0.3",
root@WOPR:~# docker restart saleor-api-dude
saleor-api-dude
root@WOPR:~# sleep 3

root@WOPR:~# docker exec saleor-api-dude getent hosts saleor-postgres-dude
172.20.0.6      saleor-postgres-dude
root@WOPR:~# docker inspect saleor-api-dude --format '{{range .Config.Env}}{{println .}}{{end}}'
DATABASE_URL=postgres://saleor:saleor@saleor-postgres-dude:5432/saleor
REDIS_URL=redis://saleor-redis-dude:6379/1
SECRET_KEY=changeme_to_random_string
ALLOWED_HOSTS=127.0.0.1,localhost,dudeabides.wopr.systems,*
DEBUG=True
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
LANG=C.UTF-8
GPG_KEY=7169605F62C751356D054A26A821E680E5FA6305
PYTHON_VERSION=3.12.12
PYTHON_SHA256=fb85a13414b028c49ba18bbd523c2d055a30b56b18b92ce454ea2c51edc656c4
STATIC_URL=/static/
PYTHONUNBUFFERED=1

root@WOPR:~# docker network inspect authentik_default | grep -A5 "IPAM" | head -10
        "IPAM": {
            "Driver": "default",
            "Options": null,
            "Config": [
                {
                    "Subnet": "172.20.0.0/16",
--
            "IPAM": {
                "Subnets": {
                    "172.20.0.0/16": {
root@WOPR:~# # Stop and remove existing containers
root@WOPR:~# for svc in saleor-worker-dude saleor-api-dude saleor-redis-dude saleor-postgres-dude saleor-dashboard-dude; do
>   docker stop "$svc" 2>/dev/null; docker rm "$svc" 2>/dev/null
> done

saleor-worker-dude
saleor-worker-dude
saleor-api-dude
saleor-api-dude
saleor-redis-dude
saleor-redis-dude
saleor-postgres-dude
saleor-postgres-dude
saleor-dashboard-dude
saleor-dashboard-dude
root@WOPR:~#
root@WOPR:~# # Generate proper secret
root@WOPR:~# SECRET=$(openssl rand -hex 32)
root@WOPR:~# echo "SECRET_KEY: $SECRET"
SECRET_KEY: cad128314a54f10a1ecfc5424bd4b3174a8e190b7ed144151dccb97cc7356606
root@WOPR:~#
root@WOPR:~# # Postgres at 172.20.50.10
root@WOPR:~# docker run -d --name saleor-postgres-dude \
>   --network authentik_default --ip 172.20.50.10 \
>   -e POSTGRES_DB=saleor -e POSTGRES_USER=saleor -e POSTGRES_PASSWORD=saleor \
>   -v saleor_postgres:/var/lib/postgresql/data \
>   postgres:15-alpine
3389c8e3fdfc988c2e11b8594699d51309f7f49821ff52c740818d85d5b88ae8
root@WOPR:~#
root@WOPR:~# sleep 5
root@WOPR:~#
root@WOPR:~# # Redis at 172.20.50.11
root@WOPR:~# docker run -d --name saleor-redis-dude \
>   --network authentik_default --ip 172.20.50.11 \
>   redis:7-alpine
3ea12a58760838ffae7cdcf268d907688070fe00ad0e0719fb99194f323af050
root@WOPR:~#
root@WOPR:~# # API at 172.20.50.12
root@WOPR:~# docker run -d --name saleor-api-dude \
>   --network authentik_default --ip 172.20.50.12 \
>   -p 8000:8000 \
>   -e DATABASE_URL="postgres://saleor:saleor@172.20.50.10:5432/saleor" \
>   -e REDIS_URL="redis://172.20.50.11:6379/1" \
>   -e SECRET_KEY="$SECRET" \
>   -e ALLOWED_HOSTS="127.0.0.1,localhost,dudeabides.wopr.systems" \
>   -e DEBUG=False \
>   ghcr.io/saleor/saleor:3.20
a00810d532ef2d9ff29fa1bbe3ad2067f78a9deacf2a544399b28814032b463a
root@WOPR:~#
root@WOPR:~# # Worker at 172.20.50.13
root@WOPR:~# docker run -d --name saleor-worker-dude \
>   --network authentik_default --ip 172.20.50.13 \
>   -e DATABASE_URL="postgres://saleor:saleor@172.20.50.10:5432/saleor" \
>   -e REDIS_URL="redis://172.20.50.11:6379/1" \
>   -e SECRET_KEY="$SECRET" \
>   ghcr.io/saleor/saleor:3.20
9a5fc208cbd6811500bc57d7381ff3ed6cd7f9e3df422726406d8e148ff5f27c
root@WOPR:~#
root@WOPR:~# # Dashboard at 172.20.50.14
root@WOPR:~# docker run -d --name saleor-dashboard-dude \
>   --network authentik_default --ip 172.20.50.14 \
>   -p 9002:80 \
>   -e API_URL=https://dudeabides.wopr.systems/graphql/ \
>   -e APP_MOUNT_URI=/dashboard/ \
>   ghcr.io/saleor/saleor-dashboard:3.20
fb43ad09df604b14f3d833375b4aa34fa6499893a92d4404796b21c87d131104
root@WOPR:~#
root@WOPR:~# # Verify
root@WOPR:~# sleep 5
root@WOPR:~# docker logs saleor-api-dude --tail 5
  File "/app/saleor/settings.py", line 102, in <module>
    raise ImproperlyConfigured(
django.core.exceptions.ImproperlyConfigured: ALLOWED_CLIENT_HOSTS environment variable must be set when DEBUG=False.
]

root@WOPR:~# docker inspect saleor-postgres-dude --format '{{.NetworkSettings.Networks.authentik_default.IPAddress}}'
172.20.50.10
root@WOPR:~#